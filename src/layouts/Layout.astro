---
import Footer from "../components/elements/Footer.astro";
import Navbar from "../components/elements/Navbar.astro";
import WhatsAppButton from "../components/elements/WhatsAppButton.astro";

export interface Props {
  title: string;
  description?: string;
  ogImage?: string;
  canonical?: string;
}

const { 
  title, 
  description = "Desarrollo de páginas web profesionales y sistemas administrativos a medida en Costa Rica. Optimiza, automatiza tu negocio y desbloquea nuevas fronteras digitales con BIESAL.",
  ogImage = "/images/Logo_1024x1024.webp",
  canonical = "https://biesal.com"
} = Astro.props;

const fullTitle = `BIESAL - ${title}`;
const fullOgImage = new URL(ogImage, Astro.site).href;
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="generator" content={Astro.generator} />
    
    <!-- Primary Meta Tags -->
    <title>{fullTitle}</title>
    <meta name="title" content={fullTitle} />
    <meta name="description" content={description} />
    <meta name="keywords" content="desarrollo web costa rica, páginas web profesionales, sistemas administrativos, automatización empresarial, diseño web heredia, software a medida" />
    <meta name="author" content="BIESAL" />
    <meta name="robots" content="index, follow" />
    <link rel="canonical" href={canonical} />
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonical} />
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={fullOgImage} />
    <meta property="og:locale" content="es_CR" />
    <meta property="og:site_name" content="BIESAL" />
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonical} />
    <meta property="twitter:title" content={fullTitle} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={fullOgImage} />
    
    <!-- Google Site Verification -->
    <meta name="google-site-verification" content="_QwyqSR2XVZEGkv3HMIVIohPC7aApIVEMNwlOYS3rCU" />
    
    <!-- Bing Site Verification -->
    <meta name="msvalidate.01" content="B598D09F351A7E418E130D62AA8102A1" />

    <link rel="icon" type="image/x-icon" href="/favicon.ico" />

    <!-- High-value preconnects for fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <!-- Light-weight DNS hints for 3rd parties (non-critical) -->
    <link rel="dns-prefetch" href="https://www.googletagmanager.com" />
    <link rel="dns-prefetch" href="https://app.cal.com" />
    <link rel="dns-prefetch" href="https://elfsightcdn.com" />

    <!-- Google Fonts stylesheet (display=swap to avoid FOIT) -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;500;600;700&display=swap"
    />

    <!-- Elfsight Google Reviews -->
    <script src="https://elfsightcdn.com/platform.js" async></script>
    
    <!-- Structured Data / Schema.org -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "LocalBusiness",
        "name": "BIESAL",
        "description": "Desarrollo de páginas web profesionales y sistemas administrativos a medida en Costa Rica",
        "url": "https://biesal.com",
        "logo": "https://biesal.com/favicon.svg",
        "image": "https://biesal.com/images/Logo_1024x1024.webp",
        "address": {
          "@type": "PostalAddress",
          "addressLocality": "Heredia",
          "addressRegion": "Heredia",
          "addressCountry": "CR"
        },
        "geo": {
          "@type": "GeoCoordinates",
          "latitude": "9.9981",
          "longitude": "-84.1170"
        },
        "sameAs": [
          "https://www.facebook.com/biesal",
          "https://www.instagram.com/biesal"
        ],
        "priceRange": "$$",
        "areaServed": {
          "@type": "Country",
          "name": "Costa Rica"
        }
      }
    </script>
  </head>
  <body class="overflow-hidden overflow-y-auto bg-body">
    <!-- Finisher Header Background - Fixed to viewport -->
    <div
      class="header finisher-header"
      style="position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 0; pointer-events: none;"
    >
    </div>

    <!-- Content wrapper with relative positioning -->
    <div style="position: relative; z-index: 1;">
      <Navbar />
      <slot />

      <!-- Elfsight Google Reviews Widget -->
      <div
        class="elfsight-app-0c12f1f6-b967-4bc8-b522-e240661a1c82"
        data-elfsight-app-lazy
      >
      </div>

      <Footer />
    </div>

    <!-- WhatsApp Button -->
    <WhatsAppButton />

    <!-- Finisher Header Script (deferred) -->
    <script src="/scripts/finisher-header.es5.min.js" defer></script>

    <!-- Theme + FinisherHeader init, runs after page load -->
    <script is:inline>
      const lightTheme = {
        count: 90,
        size: { min: 2, max: 6, pulse: 0 },
        speed: {
          x: { min: 0, max: 0.35 },
          y: { min: 0, max: 0.55 },
        },
        colors: {
          background: "#f9fafb",
          particles: ["#4f46e5", "#10b981", "#3b82f6"],
        },
        blending: "overlay",
        opacity: { center: 0.9, edge: 0.08 },
        skew: 0,
        shapes: ["c"],
      };

      const darkTheme = {
        count: 110,
        size: { min: 2, max: 7, pulse: 0 },
        speed: {
          x: { min: 0, max: 0.35 },
          y: { min: 0, max: 0.6 },
        },
        colors: {
          background: "#020617",
          particles: ["#6366f1", "#22c55e", "#38bdf8"],
        },
        blending: "screen",
        opacity: { center: 0.95, edge: 0.05 },
        skew: 0,
        shapes: ["c"],
      };

      function initHeader(config) {
        // FinisherHeader is provided by /scripts/finisher-header.es5.min.js
        new FinisherHeader(config);
      }

      function getInitialTheme() {
        try {
          const stored = localStorage.getItem("appTheme");
          // Only return dark if explicitly set by user, otherwise always light
          if (stored === "dark") {
            return "dark";
          }
        } catch (e) {
          // ignore storage errors
        }
        return "light";
      }

      window.addEventListener("load", () => {
        let currentTheme = getInitialTheme();

        if (currentTheme === "dark") {
          document.documentElement.classList.add("dark");
          initHeader(darkTheme);
        } else {
          document.documentElement.classList.remove("dark");
          initHeader(lightTheme);
        }

        const switchTheme = document.querySelector("[data-switch-theme]");
        if (switchTheme) {
          switchTheme.addEventListener("click", (e) => {
            e.preventDefault();

            currentTheme = currentTheme === "light" ? "dark" : "light";

            try {
              localStorage.setItem("appTheme", currentTheme);
            } catch (e) {
              // ignore
            }

            if (currentTheme === "dark") {
              document.documentElement.classList.add("dark");
              initHeader(darkTheme);
            } else {
              document.documentElement.classList.remove("dark");
              initHeader(lightTheme);
            }
          });
        }
      });
    </script>

    <!-- Navbar mobile toggle (no TS syntax, safe JS) -->
    <script is:inline>
      window.addEventListener("DOMContentLoaded", () => {
        const toggleMenu = document.querySelector("[data-toggle-nav]");
        const navbar = document.querySelector("[data-navbar]");
        const overlayNav = document.querySelector("[data-nav-overlay]");

        if (!toggleMenu || !navbar || !overlayNav) return;

        function closeNav() {
          toggleMenu.setAttribute("data-open-nav", "false");
          overlayNav.setAttribute("data-is-visible", "false");
          document.body.classList.remove("!overflow-y-hidden");
          navbar.style.height = "0px";
        }

        toggleMenu.addEventListener("click", (e) => {
          e.preventDefault();
          const isOpen = toggleMenu.getAttribute("data-open-nav") === "true";

          if (!isOpen) {
            toggleMenu.setAttribute("data-open-nav", "true");
            overlayNav.setAttribute("data-is-visible", "true");
            document.body.classList.add("!overflow-y-hidden");
            navbar.style.height = `${navbar.scrollHeight}px`;
          } else {
            closeNav();
          }
        });

        navbar.addEventListener("click", () => {
          closeNav();
        });

        overlayNav.addEventListener("click", () => {
          closeNav();
        });
      });
    </script>

    <!-- Google Analytics (loaded during idle / later, not blocking) -->
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        window.dataLayer.push(arguments);
      }

      function loadGtag() {
        const script = document.createElement("script");
        script.src = "https://www.googletagmanager.com/gtag/js?id=G-8GPG4P5KT6";
        script.async = true;
        document.head.appendChild(script);

        gtag("js", new Date());
        gtag("config", "G-8GPG4P5KT6");
      }

      if ("requestIdleCallback" in window) {
        requestIdleCallback(loadGtag);
      } else {
        setTimeout(loadGtag, 3000);
      }
    </script>
  </body>
</html>

<style is:global>
  :root {
    --color-bg: 255 255 255;
    --color-border: 255 255 255;
    --color-box: 255 255 255;
    --box-border: 229 231 235;
    --box-sd: 226 232 240 / 0.5;
    --heading-1: 23 37 84;
    --heading-2: 31 41 55;
    --heading-3: 55 65 81;
  }

  .dark {
    --color-bg: 3 7 18;
    --color-box: 17 24 39;
    --box-border: 243 244 246 / 0.1;
    --box-sd: transparent;

    --heading-1: 255 255 255;
    --heading-2: 243 244 246;
    --heading-3: 209 213 219;
  }

  html {
    scroll-behavior: smooth;
  }

  body {
    font-family: "Raleway", sans-serif;
  }

  [data-toggle-nav][data-open-nav="true"] #line1 {
    transform: translateY(0.375rem) rotate(40deg);
  }
  [data-toggle-nav][data-open-nav="true"] #line2 {
    transform: scaleX(0);
    opacity: 0;
  }
  [data-toggle-nav][data-open-nav="true"] #line3 {
    transform: translateY(-0.375rem) rotate(-40deg);
  }

  [data-nav-overlay][data-is-visible="true"] {
    visibility: visible;
    display: flex;
  }

  /* Finisher Header - ensure it stays behind all content */
  .finisher-header {
    pointer-events: none;
  }
</style>