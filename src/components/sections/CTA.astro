---
import Button from "../shared/Button.astro";
import Container from "../shared/Container.astro";
import ContactButton from "../shared/ContactButton.astro";
---

<section id="cta" class="pb-20">
  <Container>
    <div
      class="w-full relative py-8 md:py-10 px-6 md:px-8 rounded-2xl bg-gradient-to-tr from-gray-100 to-gray-200 dark:from-gray-900 dark:to-transparent"
    >
      <div class="absolute right-0 top-0 h-full w-full flex justify-end">
        <div class="w-28 h-28 overflow-auto flex rounded-xl relative blur-2xl">
          <span
            class="absolute w-16 h-16 -top-1 -right-1 bg-green-500 rounded-md rotate-45"
          ></span>
          <span
            class="absolute w-16 h-16 -bottom-1 -right-1 bg-[#FCDC58] rounded-md rotate-45"
          ></span>
          <span
            class="absolute w-16 h-16 -bottom-1 -left-1 bg-primary rounded-md rotate-45"
          ></span>
        </div>
      </div>

      <div class="absolute left-0 bottom-0 h-full w-full flex items-end">
        <div class="w-28 h-28 overflow-auto flex rounded-xl relative blur-2xl">
          <span
            class="absolute w-16 h-16 -top-1 -right-1 bg-green-500 rounded-md rotate-45"
          ></span>
          <span
            class="absolute w-16 h-16 -bottom-1 -right-1 bg-[#FCDC58] rounded-md rotate-45"
          ></span>
          <span
            class="absolute w-16 h-16 -bottom-1 -left-1 bg-primary rounded-md rotate-45"
          ></span>
        </div>
      </div>

      <div class="mx-auto text-center max-w-xl md:max-w-2xl relative">
        <h1
          class="text-3xl/tight sm:text-4xl/tight md:text-5xl/tight
          font-bold text-heading-1"
        >
          Contáctenos hoy para dar el primer paso hacia una <span
            class="bg-clip-text text-transparent bg-gradient-to-r from-primary to-orange-400"
            >presencia digital</span
          > destacada. ¡Estamos listos para empezar su proyecto!
        </h1>
        <div
          class="mx-auto max-w-md sm:max-w-xl pt-10 flex flex-wrap justify-center gap-4"
        >
          <!-- WhatsApp Button -->
          <a
            href="https://wa.me/50600000000"
            target="_blank"
            rel="noopener
          noreferrer"
            class="block"
          >
            <ContactButton text="Solicítalo" icon="whatsapp" />
          </a>

          <!-- Google Meet Button -->

          <a
            id="cal-button-reunion"
            data-cal-link="isaac-bermudez-f04bo3/cotizacion"
            data-cal-namespace="cotizacion"
            rel="noopener noreferrer"
            class="block"
          >
            <!-- Google Meet button -->
            <ContactButton text="Sesión virtual" icon="google-meet" />
          </a>
        </div>
      </div>
    </div>

    <script>
      // 1. Define la función de inicialización de Cal.com
      function initializeCalCom() {
        // 2. Obtener el tema de localStorage. Si no está definido o es inválido, usa 'light' como fallback.
        const storedTheme = localStorage.getItem("appTheme");
        const theme =
          storedTheme === "light" || storedTheme === "dark"
            ? storedTheme
            : "light";

        // 3. Definir la configuración JSON que Cal.com necesita (incluyendo el tema dinámico)
        const calConfig = JSON.stringify({
          layout: "month_view",
          theme: theme, // <-- Tema dinámico
        });

        // 4. Aplicar la configuración al elemento del botón
        const calButton = document.getElementById("cal-button-reunion");
        if (calButton) {
          calButton.setAttribute("data-cal-config", calConfig);
        }

        // 5. Inicialización base del Embed de Cal.com (el código ofuscado)
        (function (C, A, L) {
          let p = function (a, ar) {
            a.q.push(ar);
          };
          let d = C.document;
          C.Cal =
            C.Cal ||
            function () {
              let cal = C.Cal;
              let ar = arguments;
              if (!cal.loaded) {
                cal.ns = {};
                cal.q = cal.q || [];
                d.head.appendChild(d.createElement("script")).src = A;
                cal.loaded = true;
              }
              if (ar[0] === L) {
                const api = function () {
                  p(api, arguments);
                };
                const namespace = ar[1];
                api.q = api.q || [];
                if (typeof namespace === "string") {
                  cal.ns[namespace] = cal.ns[namespace] || api;
                  p(cal.ns[namespace], ar);
                  p(cal, ["initNamespace", namespace]);
                } else p(cal, ar);
                return;
              }
              p(cal, ar);
            };
        })(window, "https://app.cal.com/embed/embed.js", "init");

        // 6. Configurar el namespace y la UI (estos deben ser llamados después de que Cal() se haya cargado)
        Cal("init", "cotizacion", { origin: "https://app.cal.com" });

        // La configuración de la UI de Cal.com requiere el tema de nuevo, y aplica estilos.
        // Esto asegura que Cal.com use tu CSS variable de marca en modo light.
        Cal.ns.cotizacion("ui", {
          theme: theme, // <-- Tema dinámico para la UI
          cssVarsPerTheme: { light: { "cal-brand": "#030712" } },
          hideEventTypeDetails: false,
          layout: "month_view",
        });

        // 7. Carga final del script si no existía (redundancia de seguridad)
        if (!window.Cal || !window.Cal.loaded) {
          const script = document.createElement("script");
          script.src = "https://app.cal.com/embed/embed.js";
          document.head.appendChild(script);
          window.Cal = window.Cal || {};
          window.Cal.loaded = true;
        }
      }

      // Ejecutar la inicialización cuando el DOM esté listo
      document.addEventListener("DOMContentLoaded", initializeCalCom);
    </script>
  </Container>
</section>
